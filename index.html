<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SayurID</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar untuk tampilan yang lebih bersih */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #4ade80; /* Hijau Tailwind 400 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #22c55e; /* Hijau Tailwind 500 */
        }
        
        .page-content {
            padding-bottom: 80px; /* Jarak agar konten tidak tertutup navbar bawah */
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <!-- Konten Halaman Utama -->
    <div class="page-content container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Halaman Home -->
        <div id="home-page" class="page active text-center py-12">
            <h1 class="text-4xl sm:text-5xl font-bold text-green-600 mb-4">SayurID ü•¶</h1>
            <p class="text-gray-600 text-lg mb-8 max-w-xl mx-auto">Menyediakan sayuran segar langsung dari petani, kualitas terbaik dengan harga terjangkau.</p>
            <button id="cta-katalog" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300">
                Lihat Katalog
            </button>
        </div>

        <!-- Halaman Katalog -->
        <div id="katalog-page" class="page">
            <h2 class="text-3xl font-bold text-green-700 mb-6">Katalog Sayuran</h2>
            <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Produk akan dimuat di sini oleh JavaScript -->
            </div>
        </div>

        <!-- Halaman Keranjang -->
        <div id="keranjang-page" class="page">
            <h2 class="text-3xl font-bold text-green-700 mb-6">Keranjang Belanja</h2>
            <div id="cart-list" class="space-y-4">
                <!-- Item keranjang akan dimuat di sini oleh JavaScript -->
            </div>
            <div id="cart-summary" class="mt-8 p-6 bg-white rounded-lg shadow-md border-t-2 border-green-500">
                <p class="text-lg font-semibold text-gray-800">Total: <span id="cart-total-price" class="text-xl font-bold text-green-600">Rp0</span></p>
                
                <!-- Tombol baru untuk fitur Gemini AI: Resep Otomatis -->
                <button id="get-recipe-button" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:opacity-50" disabled>
                    ‚ú® Dapatkan Resep Otomatis
                </button>

                <button id="checkout-button" class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:opacity-50" disabled>
                    Checkout via WhatsApp
                </button>
            </div>
            <!-- Area untuk menampilkan hasil resep -->
            <div id="recipe-area" class="mt-8 p-6 bg-white rounded-lg shadow-md border-t-2 border-green-500 hidden">
                <h3 class="text-xl font-bold text-green-700 mb-2">Resep yang Disarankan</h3>
                <div id="recipe-content" class="text-gray-700 whitespace-pre-wrap"></div>
                <div id="recipe-loading" class="text-center text-gray-500 hidden">
                    <p class="animate-pulse">Sedang membuat resep...</p>
                </div>
            </div>
        </div>

        <!-- Halaman Login Admin -->
        <div id="login-page" class="page flex items-center justify-center min-h-screen">
            <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
                <h2 class="text-2xl font-bold text-center text-green-700 mb-6">Admin Login</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="username" class="block text-gray-700 text-sm font-semibold mb-2">Username</label>
                        <input type="text" id="username" class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-gray-700 text-sm font-semibold mb-2">Password</label>
                        <input type="password" id="password" class="shadow-sm appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300">
                        Login
                    </button>
                    <p id="login-error" class="text-red-500 text-sm mt-4 text-center hidden">Username atau password salah.</p>
                </form>
            </div>
        </div>

        <!-- Halaman Admin Panel -->
        <div id="admin-page" class="page">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-green-700">Admin Panel</h2>
                <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white text-sm font-bold py-2 px-4 rounded-lg transition duration-300">
                    Logout
                </button>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md mb-8 border-t-2 border-green-500">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Tambah Produk Baru</h3>
                <form id="add-product-form" class="space-y-4">
                    <div>
                        <label for="product-name" class="block text-gray-700 font-semibold mb-1">Nama Produk</label>
                        <input type="text" id="product-name" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="product-price" class="block text-gray-700 font-semibold mb-1">Harga (Rp)</label>
                        <input type="number" id="product-price" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="product-desc" class="block text-gray-700 font-semibold mb-1">Deskripsi</label>
                        <textarea id="product-desc" rows="3" class="w-full p-2 border border-gray-300 rounded-lg" required></textarea>
                         <!-- Tombol baru untuk fitur Gemini AI: Deskripsi Otomatis -->
                        <button id="generate-desc-button" type="button" class="mt-2 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-lg transition duration-300">
                            ‚ú® Buat Deskripsi Otomatis
                        </button>
                    </div>
                    <div>
                        <label for="product-image" class="block text-gray-700 font-semibold mb-1">Unggah Gambar</label>
                        <input type="file" id="product-image" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg transition duration-300">
                        Tambah Produk
                    </button>
                </form>
            </div>
            
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Daftar Produk</h3>
            <p id="user-id-display" class="text-gray-500 text-sm mb-4"></p>
            <div id="admin-product-list" class="space-y-4">
                <!-- Daftar produk admin akan dimuat di sini -->
            </div>
        </div>

    </div>

    <!-- Bottom Navbar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50">
        <div class="flex justify-around items-center h-16">
            <button class="nav-button flex flex-col items-center text-sm text-gray-600 hover:text-green-500 transition-colors" data-page="home-page">
                üè† <span class="mt-1">Home</span>
            </button>
            <button class="nav-button flex flex-col items-center text-sm text-gray-600 hover:text-green-500 transition-colors" data-page="katalog-page">
                ü•¶ <span class="mt-1">Katalog</span>
            </button>
            <button class="nav-button flex flex-col items-center text-sm text-gray-600 hover:text-green-500 transition-colors" data-page="keranjang-page">
                üõí <span class="mt-1">Keranjang</span>
            </button>
            <button class="nav-button flex flex-col items-center text-sm text-gray-600 hover:text-green-500 transition-colors" data-page="login-page">
                ‚öôÔ∏è <span class="mt-1">Admin</span>
            </button>
        </div>
    </nav>
    
    <!-- Custom Message Box -->
    <div id="message-box" class="message-box bg-green-500 text-white px-6 py-3 rounded-full shadow-lg transform scale-0 transition-transform duration-300 ease-out">
        Pesan
    </div>


    <!-- JavaScript untuk Fungsionalitas -->
    <script type="module">
        // Impor pustaka Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, addDoc, deleteDoc, updateDoc, getDoc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Atur level log Firebase ke Debug untuk melihat log di konsol
        setLogLevel('Debug');

        document.addEventListener('DOMContentLoaded', () => {
            // Data
            const WA_NUMBER = '6288971897497'; // Ganti dengan nomor WhatsApp Elvina
            const ADMIN_USERNAME = 'Admin';
            const ADMIN_PASSWORD = '123';
            
            // Variabel Firebase
            const firebaseConfig = JSON.parse(__firebase_config);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            let db;
            let auth;
            let userId;

            // Elemen DOM
            const pages = document.querySelectorAll('.page');
            const navButtons = document.querySelectorAll('.nav-button');
            const ctaKatalog = document.getElementById('cta-katalog');
            const productList = document.getElementById('product-list');
            const cartList = document.getElementById('cart-list');
            const cartTotalPrice = document.getElementById('cart-total-price');
            const checkoutButton = document.getElementById('checkout-button');
            const loginForm = document.getElementById('login-form');
            const adminPage = document.getElementById('admin-page');
            const loginPage = document.getElementById('login-page');
            const logoutButton = document.getElementById('logout-button');
            const addProductForm = document.getElementById('add-product-form');
            const adminProductList = document.getElementById('admin-product-list');
            const loginError = document.getElementById('login-error');
            const userIdDisplay = document.getElementById('user-id-display');
            const messageBox = document.getElementById('message-box');

            // Elemen DOM baru untuk fitur Gemini API
            const getRecipeButton = document.getElementById('get-recipe-button');
            const recipeArea = document.getElementById('recipe-area');
            const recipeContent = document.getElementById('recipe-content');
            const recipeLoading = document.getElementById('recipe-loading');
            const generateDescButton = document.getElementById('generate-desc-button');
            const productNameInput = document.getElementById('product-name');
            const productDescTextarea = document.getElementById('product-desc');

            // --- Variabel data lokal ---
            let products = [];
            let cart = [];

            // --- Fungsi utilitas ---
            const showMessage = (message) => {
                messageBox.textContent = message;
                messageBox.classList.remove('scale-0');
                messageBox.classList.add('scale-100');
                setTimeout(() => {
                    messageBox.classList.remove('scale-100');
                    messageBox.classList.add('scale-0');
                }, 3000);
            };

            // --- Fungsi Gemini API ---
            const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=';
            const API_KEY = ""; // Kunci API akan disediakan oleh platform

            const callGeminiApi = async (prompt) => {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }]
                };
                
                let attempts = 0;
                const maxAttempts = 5;
                const baseDelay = 1000;

                while(attempts < maxAttempts) {
                    try {
                        const response = await fetch(GEMINI_API_URL + API_KEY, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429) {
                            // Too Many Requests, implement exponential backoff
                            attempts++;
                            const delay = baseDelay * Math.pow(2, attempts);
                            await new Promise(res => setTimeout(res, delay));
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        return result.candidates[0].content.parts[0].text;
                    } catch (error) {
                        console.error("Error calling Gemini API:", error);
                        attempts++;
                        if (attempts >= maxAttempts) {
                            throw error;
                        }
                        const delay = baseDelay * Math.pow(2, attempts);
                        await new Promise(res => setTimeout(res, delay));
                    }
                }
            };

            // --- Fungsionalitas Aplikasi ---

            // Fungsi navigasi halaman
            const showPage = (pageId) => {
                pages.forEach(page => {
                    page.classList.remove('active');
                });
                document.getElementById(pageId).classList.add('active');
                window.scrollTo(0, 0); // Gulir ke atas halaman saat pindah halaman
            };

            // Event listener untuk navigasi
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const page = button.getAttribute('data-page');
                    if (page === 'admin-page') {
                        // Jika Admin Panel, cek status login
                        if (sessionStorage.getItem('isLoggedIn') === 'true') {
                            showPage('admin-page');
                        } else {
                            showPage('login-page');
                        }
                    } else {
                        showPage(page);
                    }
                });
            });

            ctaKatalog.addEventListener('click', () => showPage('katalog-page'));

            // Render produk di halaman Katalog
            const renderProducts = () => {
                productList.innerHTML = '';
                if (products.length === 0) {
                    productList.innerHTML = '<p class="text-center text-gray-500">Belum ada produk. Tambahkan produk dari halaman Admin.</p>';
                } else {
                    products.forEach(product => {
                        const productCard = document.createElement('div');
                        productCard.className = 'bg-white rounded-lg shadow-md overflow-hidden transform transition duration-300 hover:scale-105';
                        productCard.innerHTML = `
                            <img src="${product.image}" alt="${product.name}" class="w-full h-48 object-cover">
                            <div class="p-4">
                                <h3 class="text-xl font-bold text-gray-800 mb-1">${product.name}</h3>
                                <p class="text-green-600 font-semibold mb-2">Rp${product.price.toLocaleString('id-ID')}</p>
                                <p class="text-gray-500 text-sm h-12 overflow-hidden mb-4">${product.description}</p>
                                <button data-id="${product.id}" class="add-to-cart-btn w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg transition duration-300">
                                    Tambah ke Keranjang
                                </button>
                            </div>
                        `;
                        productList.appendChild(productCard);
                    });
                }
            };

            // Fungsi Keranjang
            const renderCart = () => {
                cartList.innerHTML = '';
                let total = 0;

                if (cart.length === 0) {
                    cartList.innerHTML = '<p class="text-center text-gray-500">Keranjangmu kosong.</p>';
                    checkoutButton.disabled = true;
                    getRecipeButton.disabled = true;
                } else {
                    checkoutButton.disabled = false;
                    getRecipeButton.disabled = false;
                    cart.forEach(item => {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'flex justify-between items-center bg-white p-4 rounded-lg shadow-sm';
                        itemElement.innerHTML = `
                            <div>
                                <h4 class="font-bold text-gray-800">${item.name}</h4>
                                <p class="text-gray-600 text-sm">${item.quantity} x Rp${item.price.toLocaleString('id-ID')}</p>
                            </div>
                            <div class="flex items-center">
                                <button data-id="${item.id}" class="remove-from-cart-btn bg-red-500 text-white p-1 rounded-full text-xs h-6 w-6 flex items-center justify-center">-</button>
                                <span class="mx-3 font-semibold text-gray-700">${item.quantity}</span>
                                <button data-id="${item.id}" class="add-to-cart-btn bg-green-500 text-white p-1 rounded-full text-xs h-6 w-6 flex items-center justify-center">+</button>
                            </div>
                        `;
                        cartList.appendChild(itemElement);
                        total += item.price * item.quantity;
                    });
                }
                cartTotalPrice.textContent = `Rp${total.toLocaleString('id-ID')}`;
            };

            const addToCart = async (productId) => {
                if (!userId) {
                    showMessage("Autentikasi belum selesai. Silakan coba lagi.");
                    return;
                }
                const productToAdd = products.find(p => p.id == productId);
                if (!productToAdd) return;

                const cartRef = doc(db, 'artifacts', appId, 'users', userId, 'cart', productId);
                const cartDoc = await getDoc(cartRef);

                if (cartDoc.exists()) {
                    await updateDoc(cartRef, {
                        quantity: cartDoc.data().quantity + 1
                    });
                } else {
                    await setDoc(cartRef, {
                        id: productToAdd.id,
                        name: productToAdd.name,
                        price: productToAdd.price,
                        quantity: 1
                    });
                }
                showMessage(`${productToAdd.name} ditambahkan ke keranjang!`);
            };

            const removeFromCart = async (productId) => {
                if (!userId) {
                    showMessage("Autentikasi belum selesai. Silakan coba lagi.");
                    return;
                }
                const cartRef = doc(db, 'artifacts', appId, 'users', userId, 'cart', productId);
                const cartDoc = await getDoc(cartRef);

                if (cartDoc.exists()) {
                    const currentQuantity = cartDoc.data().quantity;
                    if (currentQuantity > 1) {
                        await updateDoc(cartRef, {
                            quantity: currentQuantity - 1
                        });
                    } else {
                        await deleteDoc(cartRef);
                    }
                }
            };

            // Event listener untuk tombol Tambah/Kurang di Keranjang
            cartList.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart-btn')) {
                    const id = e.target.dataset.id;
                    addToCart(id);
                }
                if (e.target.classList.contains('remove-from-cart-btn')) {
                    const id = e.target.dataset.id;
                    removeFromCart(id);
                }
            });
            
            // Event listener untuk tombol 'Tambah ke Keranjang'
            productList.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart-btn')) {
                    const id = e.target.dataset.id;
                    addToCart(id);
                }
            });

            // Checkout via WhatsApp
            checkoutButton.addEventListener('click', () => {
                if (cart.length === 0) return;

                let message = 'Halo Elvina, saya ingin memesan sayuran:\n\n';
                let total = 0;
                cart.forEach(item => {
                    message += `${item.quantity}x ${item.name} (@Rp${item.price.toLocaleString('id-ID')})\n`;
                    total += item.price * item.quantity;
                });
                message += `\nTotal: Rp${total.toLocaleString('id-ID')}\n\nTerima kasih!`;
                
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/${WA_NUMBER}?text=${encodedMessage}`;
                window.open(whatsappUrl, '_blank');
            });

            // FITUR GEMINI: Dapatkan Resep Otomatis
            getRecipeButton.addEventListener('click', async () => {
                if (cart.length === 0) {
                    showMessage('Keranjang Anda kosong. Tambahkan sayuran terlebih dahulu.');
                    return;
                }

                getRecipeButton.disabled = true;
                recipeArea.classList.add('hidden');
                recipeLoading.classList.remove('hidden');

                const ingredients = cart.map(item => item.name).join(', ');
                const prompt = `Buatkan resep sederhana dan singkat menggunakan bahan-bahan berikut: ${ingredients}. Resep harus berisi judul, daftar bahan, dan langkah-langkah yang jelas. Gunakan bahasa Indonesia.`;
                
                try {
                    const recipeText = await callGeminiApi(prompt);
                    recipeContent.innerText = recipeText;
                    recipeArea.classList.remove('hidden');
                } catch (error) {
                    recipeContent.innerText = 'Maaf, terjadi kesalahan saat membuat resep. Silakan coba lagi nanti.';
                    recipeArea.classList.remove('hidden');
                } finally {
                    getRecipeButton.disabled = false;
                    recipeLoading.classList.add('hidden');
                }
            });
            
            // Login Admin
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    showPage('admin-page');
                    loginError.classList.add('hidden');
                } else {
                    loginError.classList.remove('hidden');
                }
            });

            // Logout Admin
            logoutButton.addEventListener('click', () => {
                sessionStorage.removeItem('isLoggedIn');
                showPage('home-page');
                showMessage('Anda telah logout dari Admin Panel.');
            });

            // Admin Panel
            const renderAdminProducts = () => {
                adminProductList.innerHTML = '';
                if (products.length === 0) {
                    adminProductList.innerHTML = '<p class="text-center text-gray-500">Belum ada produk.</p>';
                }
                products.forEach(product => {
                    const productItem = document.createElement('div');
                    productItem.className = 'flex justify-between items-center bg-white p-4 rounded-lg shadow-sm';
                    productItem.innerHTML = `
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800">${product.name}</h4>
                            <p class="text-green-600">Rp${product.price.toLocaleString('id-ID')}</p>
                        </div>
                        <button data-id="${product.id}" class="delete-product-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg transition duration-300">
                            Hapus
                        </button>
                    `;
                    adminProductList.appendChild(productItem);
                });
            };

            // FITUR GEMINI: Buat Deskripsi Otomatis
            generateDescButton.addEventListener('click', async () => {
                const productName = productNameInput.value;
                if (!productName) {
                    showMessage('Mohon isi nama produk terlebih dahulu.');
                    return;
                }

                generateDescButton.disabled = true;
                generateDescButton.innerText = 'Sedang membuat...';

                const prompt = `Tulis deskripsi produk singkat dan menarik untuk sayuran bernama ${productName}. Deskripsi harus menyoroti manfaat utamanya dan cara penggunaannya dalam masakan. Gunakan bahasa Indonesia.`;

                try {
                    const description = await callGeminiApi(prompt);
                    productDescTextarea.value = description;
                } catch (error) {
                    showMessage('Maaf, terjadi kesalahan saat membuat deskripsi. Silakan coba lagi.');
                } finally {
                    generateDescButton.disabled = false;
                    generateDescButton.innerText = '‚ú® Buat Deskripsi Otomatis';
                }
            });

            // Tambah Produk via Admin Panel
            addProductForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const fileInput = document.getElementById('product-image');
                const file = fileInput.files[0];

                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const imageBase64 = event.target.result;
                        const newProduct = {
                            name: productNameInput.value,
                            price: parseInt(document.getElementById('product-price').value),
                            description: productDescTextarea.value,
                            image: imageBase64
                        };
                        
                        try {
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), newProduct);
                            addProductForm.reset();
                            showMessage('Produk berhasil ditambahkan!');
                        } catch (e) {
                            console.error("Error adding document: ", e);
                            showMessage("Gagal menambahkan produk.");
                        }
                    };
                    reader.readAsDataURL(file);
                } else {
                    showMessage('Mohon unggah gambar produk.');
                }
            });

            // Hapus Produk dari Admin Panel
            adminProductList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-product-btn')) {
                    const id = e.target.dataset.id;
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id));
                        showMessage('Produk berhasil dihapus!');
                    } catch (e) {
                        console.error("Error removing document: ", e);
                        showMessage("Gagal menghapus produk.");
                    }
                }
            });

            // --- Inisialisasi Firebase dan listen for changes ---
            const initFirebase = () => {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User ID:", userId);
                        userIdDisplay.textContent = `User ID: ${userId}`;

                        // Mendengarkan perubahan koleksi produk
                        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (snapshot) => {
                            products = [];
                            snapshot.forEach((doc) => {
                                products.push({ id: doc.id, ...doc.data() });
                            });
                            renderProducts();
                            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                                renderAdminProducts();
                            }
                        });

                        // Mendengarkan perubahan keranjang belanja
                        onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'cart'), (snapshot) => {
                            cart = [];
                            snapshot.forEach((doc) => {
                                cart.push({ id: doc.id, ...doc.data() });
                            });
                            renderCart();
                        });
                        
                    } else {
                        // Jika tidak ada pengguna, coba autentikasi
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase auth error:", error);
                        }
                    }
                });
            };

            initFirebase();
            showPage('home-page');
        });
    </script>

</body>
</html>
